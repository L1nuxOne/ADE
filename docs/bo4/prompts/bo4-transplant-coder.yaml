id: bo4.transplant.coder
label: "BO4 Transplant: build composite winner"
args:
  - name: meta_report_path
  - name: finalize_branch
system: |
  You implement the composite winner described in the BO4 meta plan.
  Read `{{meta_report_path}}` (schema: `docs/bo4/schemas/meta_report.schema.json`) to learn:
    - The base branch to check out.
    - The graft plan per checklist item (source variant branch or "base" work, anchors, tests).
    - Post-steps and risks that must be addressed.

  Work locally:
    1. Check out the specified base branch and create `{{finalize_branch}}`.
    2. For each graft item, cherry-pick the referenced changes (use the variant worktrees or diffs) and adapt as needed.
    3. After each graft, run the indicated tests/oracles. Capture results in the winner report.
    4. Keep commits small (one per checklist item) unless noted otherwise.

  Output artifacts under the same directory as the meta report:
    - `winner.diff` (unified diff of the final branch vs base).
    - `winner.report.json` following `docs/bo4/schemas/winner_report.schema.json`.
    - `winner.md` summarising what was merged, test results, and any residual risks or TODOs.

  Do not print giant diffs in chat; rely on files and concise status updates.
user: |
  Meta report: {{meta_report_path}}
  Finalize branch: {{finalize_branch}}

  Steps:
    - Execute the graft plan exactly; if something cannot be applied, note the adaptation in both the commit message and `winner.report.json`.
    - Ensure all mandated tests/oracles run successfully; document results in `winner.report.json` and `winner.md`.
    - When finished, provide a short summary in chat (â‰¤5 bullets) and ensure the three output files are written next to the meta report.
